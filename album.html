<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noel & Birthday Timeline</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        :root {
            --noel-red: #e63946;
            --noel-green: #2a9d8f;
            --gold: #f4a261;
            --gold-light: #e9c46a;
            --dark-blue: #0a1128;
            --medium-blue: #1e3a5f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Error Toast */
        #error-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(230, 57, 70, 0.95);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            border: 2px solid white;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            z-index: 9999;
            display: none;
            font-weight: bold;
            text-align: center;
            max-width: 90%;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* Settings Modal Specifics */
        .settings-group {
            margin-bottom: 15px;
        }
        .settings-group label {
            display: block;
            color: var(--gold);
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .settings-group input {
            width: 100%;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 5px;
            font-family: monospace;
        }
        .settings-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            color: var(--gold);
            border: 1px solid var(--gold);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.3s;
        }
        .settings-btn:hover {
            transform: rotate(90deg);
            background: var(--gold);
            color: black;
        }

        /* Loading Overlay - Christmas Style */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 17, 40, 0.95);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }
        
        .loading-container {
            position: relative;
            width: 120px;
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }

        .santa-bouncer {
            font-size: 60px;
            animation: bounce 1s infinite alternate cubic-bezier(0.5, 0.05, 1, 0.5);
            z-index: 2;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5));
        }

        .snow-spinner {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border: 4px dashed rgba(255,255,255,0.2);
            border-top-color: var(--noel-red);
            border-bottom-color: var(--noel-green);
            border-radius: 50%;
            animation: spinRing 4s linear infinite;
        }

        .snow-spinner::before, .snow-spinner::after {
            content: '‚ùÑÔ∏è';
            position: absolute;
            font-size: 20px;
        }
        .snow-spinner::before { top: 10px; left: 15px; animation: spinSelf 3s linear infinite; }
        .snow-spinner::after { bottom: 10px; right: 15px; animation: spinSelf 4s linear infinite reverse; }

        #loadingText {
            font-size: 1.5em;
            font-weight: bold;
            background: linear-gradient(to right, #f4a261, #e63946, #2a9d8f, #f4a261);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite;
            text-align: center;
            padding: 0 20px;
        }

        @keyframes bounce {
            from { transform: translateY(0) scale(1); }
            to { transform: translateY(-15px) scale(1.1); }
        }

        @keyframes spinRing {
            to { transform: rotate(360deg); }
        }

        @keyframes spinSelf {
            to { transform: rotate(360deg); }
        }

        @keyframes shine {
            to { background-position: 200% center; }
        }

        body {
            background: linear-gradient(135deg, #0a1128 0%, #1e3a5f 50%, #0a1128 100%);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            position: relative;
            min-height: 100vh;
        }

        /* Background ƒë·ªông */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(230, 57, 70, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(42, 157, 143, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(244, 162, 97, 0.08) 0%, transparent 50%);
            animation: backgroundMove 20s ease infinite;
            z-index: 0;
        }

        @keyframes backgroundMove {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(5%, -5%) rotate(120deg); }
            66% { transform: translate(-5%, 5%) rotate(240deg); }
        }

        /* ===== PAGE LOADER ===== */
#page-loader{
  position:fixed;
  inset:0;
  background:radial-gradient(circle at top,#0b1a4a,#050f2c 70%);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  transition:opacity .8s ease, visibility .8s ease;
}

#page-loader.hide{
  opacity:0;
  visibility:hidden;
}

.loader-content{
  text-align:center;
  color:#fff;
}

.loader-content h2{
  font-family:'Playfair Display',serif;
  font-size:2.4rem;
  color:#f8b229;
  text-shadow:0 0 20px rgba(248,178,41,.8);
  margin-bottom:20px;
}

.tree{
  font-size:4rem;
  animation:treeGlow 2s infinite alternate;
  margin-bottom:10px;
}

@keyframes treeGlow{
  from{filter:drop-shadow(0 0 10px #f8b229)}
  to{filter:drop-shadow(0 0 30px #ffd56a)}
}

.progress-wrap{
  width:260px;
  height:10px;
  background:rgba(255,255,255,.2);
  border-radius:999px;
  overflow:hidden;
  margin:20px auto;
}

.progress-bar{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#f8b229,#ffd56a,#fff);
  box-shadow:0 0 15px rgba(248,178,41,.9);
  animation:loading 2.5s infinite;
}

@keyframes loading{
  0%{width:0%}
  60%{width:100%}
  100%{width:100%}
}

.loader-content p{
  opacity:.8;
  font-style:italic;
}


        /* D√¢y ƒë√®n */
        .timeline-center-line {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 100%;
            z-index: 5;
            pointer-events: none;
        }

        .timeline-center-line svg {
            width: 100%;
            height: 100%;
        }

        .string-path {
            fill: none;
            stroke: url(#stringGradient);
            stroke-width: 6;
            filter: drop-shadow(0 0 10px rgba(244, 162, 97, 0.6));
        }

        .light-bulb {
            animation: bulbGlow 2s ease-in-out infinite;
        }
        .light-bulb:nth-child(2n) { animation-delay: 0.5s; }
        .light-bulb:nth-child(3n) { animation-delay: 1s; }

        @keyframes bulbGlow {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        #snow-canvas {
            position: fixed;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 100;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 60px 20px 40px;
            position: relative;
            z-index: 10;
        }

        .header h1 {
            font-size: 4em;
            font-weight: bold;
            background: linear-gradient(45deg, var(--gold), var(--gold-light), var(--noel-red));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease infinite, float 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(244, 162, 97, 0.5));
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .header p {
            font-size: 1.3em;
            color: var(--gold-light);
            margin-top: 10px;
            text-shadow: 0 0 10px rgba(244, 162, 97, 0.3);
        }

        /* Album Container */
        .album-container {
            position: relative;
            padding: 80px 20px 100px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .photo-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 120px;
            position: relative;
            opacity: 0;
            transform: translateY(30px);
            animation: fadeInUp 0.8s ease forwards;
            z-index: 20; 
        }

        @keyframes fadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }

        .timeline-dot {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--gold), var(--noel-red));
            border: 4px solid white;
            border-radius: 50%;
            z-index: 25;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            box-shadow: 0 0 30px rgba(244, 162, 97, 0.8), 0 0 60px rgba(230, 57, 70, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        .photo-side {
            width: 45%;
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.6), rgba(42, 157, 143, 0.4));
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 30px;
            border: 2px solid rgba(244, 162, 97, 0.3);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            min-height: 200px;
        }

        .photo-side::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--gold), var(--noel-red), var(--noel-green));
            border-radius: 25px;
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s;
        }

        .photo-side:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 60px rgba(244, 162, 97, 0.3);
        }

        .photo-side:hover::before { opacity: 0.3; }

        .time-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(244, 162, 97, 0.2);
        }

        .time-icon {
            font-size: 1.8em;
            color: var(--gold);
            filter: drop-shadow(0 0 10px var(--gold));
        }

        .time-input-wrapper { flex: 1; }

        .time-display {
            font-size: 1.2em;
            color: var(--gold-light);
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .time-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(244, 162, 97, 0.3);
            border-radius: 10px;
            color: white;
            padding: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .time-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 15px rgba(244, 162, 97, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }

        .save-time-btn {
            background: linear-gradient(135deg, var(--noel-green), var(--gold));
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(42, 157, 143, 0.4);
            position: relative;
            overflow: hidden;
        }

        .save-time-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(42, 157, 143, 0.6);
        }

        .empty-placeholder {
            border: 3px dashed rgba(244, 162, 97, 0.4);
            border-radius: 20px;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            transition: all 0.3s;
            background: rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 5;
        }

        .empty-placeholder:hover {
            background: rgba(244, 162, 97, 0.1);
            border-color: var(--gold);
            box-shadow: 0 0 30px rgba(244, 162, 97, 0.2);
        }

        .upload-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .upload-btn {
            background: linear-gradient(135deg, var(--gold), var(--noel-red));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(244, 162, 97, 0.4);
        }

        .upload-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 30px rgba(244, 162, 97, 0.6);
        }

        .photo-grid { position: relative; }

        .single-media {
            width: 100%;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            transition: all 0.4s;
        }

        .single-media:hover {
            transform: scale(1.03);
            box-shadow: 0 15px 40px rgba(244, 162, 97, 0.4);
        }

        .album-grid {
            display: grid;
            gap: 8px;
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }

        .album-grid:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(244, 162, 97, 0.3);
        }

        .album-grid.count-2 { grid-template-columns: repeat(2, 1fr); }
        .album-grid.count-3 { grid-template-columns: repeat(2, 1fr); }
        .album-grid.count-3 .album-item:first-child { grid-column: 1 / -1; }
        .album-grid.count-4 { grid-template-columns: repeat(2, 1fr); }
        .album-grid.count-5 { grid-template-columns: repeat(3, 1fr); }
        .album-grid.count-5 .album-item:nth-child(1),
        .album-grid.count-5 .album-item:nth-child(2) { grid-column: span 1; }

        .album-item {
            position: relative;
            aspect-ratio: 1;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.5);
        }

        .album-item img, .album-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .album-item:hover img, .album-item:hover video { transform: scale(1.1); }

        .album-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: linear-gradient(135deg, var(--noel-red), var(--gold));
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
        }

        .video-play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: rgba(244, 162, 97, 0.95);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
            pointer-events: none;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }

        .caption-input {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(244, 162, 97, 0.3);
            border-radius: 12px;
            color: white;
            width: 100%;
            padding: 15px;
            margin-top: 15px;
            font-style: italic;
            resize: vertical;
            min-height: 60px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .caption-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 20px rgba(244, 162, 97, 0.3);
            background: rgba(0, 0, 0, 0.4);
        }

        .delete-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, var(--noel-red), #c1121f);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(193, 18, 31, 0.5);
        }

        .delete-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 25px rgba(193, 18, 31, 0.7);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .modal.active { display: flex; }

        .modal-content {
            background: linear-gradient(135deg, rgba(30, 58, 95, 0.95), rgba(10, 17, 40, 0.95));
            border: 3px solid var(--gold);
            border-radius: 25px;
            max-width: 95vw;
            max-height: 90vh;
            overflow: auto;
            position: relative;
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.8);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, var(--noel-red), #c1121f);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 2em;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(193, 18, 31, 0.5);
        }

        .modal-close:hover {
            transform: scale(1.1) rotate(90deg);
        }

        .album-viewer { padding: 60px 40px 40px; }
        .album-viewer h2 { color: var(--gold); font-size: 2em; margin-bottom: 30px; text-align: center; }
        
        .album-viewer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .album-viewer-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 15px;
            overflow: hidden;
            transition: transform 0.3s;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }
        .album-viewer-item:hover { transform: scale(1.05); }
        .album-viewer-item img, .album-viewer-item video { width: 100%; height: 100%; object-fit: cover; }

        @media (max-width: 768px) {
            .photo-row { flex-direction: column; gap: 40px; }
            .photo-side { width: 100%; }
            .timeline-dot { top: -30px; left: 50%; }
            .header h1 { font-size: 2.5em; }
        }

        .nav-btn{
  position:fixed;
  top:20px;
  width:46px;
  height:46px;
  border-radius:50%;
  background:rgba(255,255,255,.15);
  backdrop-filter:blur(12px);
  border:1px solid rgba(255,255,255,.3);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.4rem;
  cursor:pointer;
  z-index:999;
  transition:.35s ease;
  box-shadow:0 8px 25px rgba(0,0,0,.4);
}

.nav-btn:hover{
  transform:scale(1.1);
  box-shadow:0 0 20px rgba(248,178,41,.8);
}

.nav-left{left:20px}
.nav-right{right:20px}



    </style>
</head>
<body>
    <div class="nav-btn nav-left" onclick="goTree()">
  ‚¨Ö
</div>

<audio id="bgMusic" src="xmayday.mp3" loop></audio>


    <div id="page-loader">
    <div class="loader-content">
        <div class="tree">üéÑ</div>
        <h2>Loading...</h2>

        <div class="progress-wrap">
        <div class="progress-bar"></div>
        </div>

        <p>V·∫°n v·∫≠t ƒë·∫øn t·ª´ em ...</p>
    </div>
    </div>
    <canvas id="snow-canvas"></canvas>
    
    <div class="header">
        <h1>üéÑ Our Story üéÑ</h1>
        <p>‚ú® H√†nh tr√¨nh c·ªßa ch√∫ng m√¨nh ‚ú®</p>
    </div>

    <div class="album-container">
        <div class="timeline-center-line">
            <svg width="100%" height="100%">
                <defs>
                    <linearGradient id="stringGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#f4a261;stop-opacity:1" />
                        <stop offset="50%" style="stop-color:#e63946;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#2a9d8f;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <path id="stringPath" class="string-path" d="" />
                <g id="lightsGroup"></g>
            </svg>
        </div>
        <div id="albumGrid"></div>
        <div id="setup-message" style="display:none; text-align:center; padding: 40px; font-size: 1.2em; color: var(--gold-light);">
            <p>üëã Ch√†o b·∫°n! ƒê·ªÉ b·∫Øt ƒë·∫ßu, h√£y b·∫•m v√†o n√∫t <strong>C√†i ƒë·∫∑t (‚öôÔ∏è)</strong> ·ªü g√≥c ph·∫£i b√™n d∆∞·ªõi ƒë·ªÉ k·∫øt n·ªëi Database.</p>
        </div>
    </div>
    
    <div style="text-align: center; padding: 40px 20px; position: relative; z-index: 100;">
        <button onclick="window.resetStory()" style="background: rgba(255,255,255,0.1); color: #aaa; border: 1px solid #555; padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
            üîÑ X√≥a h·∫øt d·ªØ li·ªáu (C·∫©n th·∫≠n)
        </button>
    </div>

    <!-- Error Toast -->
    <div id="error-toast">Error Message</div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-container">
            <div class="snow-spinner"></div>
            <div class="santa-bouncer">üéÖ</div>
        </div>
        <div id="loadingText">Em y√™u ch·ªù ch√∫t x√≠u nh√©...</div>
    </div>

    <!-- Settings Button -->
    <button class="settings-btn" onclick="window.openSettings()">‚öôÔ∏è</button>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content" style="padding: 30px; max-width: 800px;">
            <button class="modal-close" onclick="window.closeSettings()">√ó</button>
            
            <div style="display: flex; flex-wrap: wrap; gap: 30px;">
                <!-- C·ªôt Cloudinary -->
                <div style="flex: 1; min-width: 300px;">
                    <h2 style="color: var(--gold); margin-bottom: 20px; text-align: center;">‚òÅÔ∏è Cloudinary (Upload ·∫¢nh)</h2>
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 0.85em; border: 1px solid #444; height: 200px; overflow-y: auto;">
                        <p style="color: var(--noel-green); font-weight: bold;">C√°ch l·∫•y th√¥ng tin:</p>
                        <ol style="padding-left: 20px; color: #ddd; line-height: 1.5;">
                            <li>ƒêƒÉng k√Ω <a href="https://cloudinary.com/" target="_blank" style="color: var(--gold);">cloudinary.com</a>.</li>
                            <li><strong>Cloud Name</strong>: C√≥ ngay ·ªü Dashboard.</li>
                            <li><strong>Upload Preset</strong>: V√†o Settings (‚öôÔ∏è) -> Upload -> K√©o xu·ªëng Upload presets -> Add upload preset -> Ch·ªçn <strong>Signing Mode: Unsigned</strong> -> Save -> Copy t√™n preset.</li>
                        </ol>
                    </div>
                    <div class="settings-group">
                        <label>Cloud Name</label>
                        <input type="text" id="cloudNameInput" placeholder="V√≠ d·ª•: doxxyz123">
                    </div>
                    <div class="settings-group">
                        <label>Upload Preset (Unsigned)</label>
                        <input type="text" id="presetInput" placeholder="V√≠ d·ª•: my_unsigned_preset">
                    </div>
                </div>

                <!-- C·ªôt Firebase -->
                <div style="flex: 1; min-width: 300px;">
                    <h2 style="color: var(--noel-red); margin-bottom: 20px; text-align: center;">üî• Firebase (L∆∞u D·ªØ li·ªáu)</h2>
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 0.85em; border: 1px solid #444; height: 200px; overflow-y: auto;">
                        <p style="color: var(--noel-green); font-weight: bold;">C√°ch l·∫•y th√¥ng tin (Quan tr·ªçng):</p>
                        <ol style="padding-left: 20px; color: #ddd; line-height: 1.5;">
                            <li>V√†o <a href="https://console.firebase.google.com/" target="_blank" style="color: var(--gold);">console.firebase.google.com</a> -> T·∫°o Project.</li>
                            <li>V√†o <strong>Build</strong> -> <strong>Realtime Database</strong> -> <strong>Create Database</strong> -> Ch·ªçn <strong>Start in Test Mode</strong> (ƒë·ªÉ ai c≈©ng xem ƒë∆∞·ª£c).</li>
                            <li>V√†o <strong>Project Settings</strong> (b√°nh rƒÉng) -> K√©o xu·ªëng d∆∞·ªõi -> Ch·ªçn icon <strong>Web (</>)</strong> -> Register App.</li>
                            <li>Copy th√¥ng tin trong <code>firebaseConfig</code>.</li>
                        </ol>
                        <p style="color: #ff9f43; margin-top: 5px;">‚ö†Ô∏è L∆∞u √Ω: ƒê·ªÉ deploy l√™n Github cho m·ªçi ng∆∞·ªùi xem, b·∫°n n√™n copy c√°c gi√° tr·ªã n√†y v√† D√ÅN TR·ª∞C TI·∫æP v√†o code (d√≤ng 520).</p>
                    </div>
                    <div class="settings-group">
                        <label>API Key</label>
                        <input type="text" id="fbApiKey" placeholder="AIzaSy...">
                    </div>
                    <div class="settings-group">
                        <label>Project ID</label>
                        <input type="text" id="fbProjectId" placeholder="my-project-id">
                    </div>
                    <div class="settings-group">
                        <label>Database URL</label>
                        <input type="text" id="fbDbUrl" placeholder="https://...firebaseio.com">
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="save-time-btn" onclick="window.saveSettings()">üíæ L∆∞u & K·∫øt n·ªëi</button>
            </div>
        </div>
    </div>

    <div class="modal" id="albumModal">
        <div class="modal-content">
            <button class="modal-close" onclick="window.closeModal()">√ó</button>
            <div class="album-viewer" id="albumViewer"></div>
        </div>
    </div>

    <div class="modal" id="videoModal">
        <div class="modal-content" style="padding: 20px;">
            <button class="modal-close" onclick="window.closeVideoModal()">√ó</button>
            <video id="videoPlayer" controls style="width: 100%; max-width: 900px; border-radius: 15px;"></video>
        </div>
    </div>

    <!-- Image Modal (Lightbox) -->
    <div class="modal" id="imageModal">
        <div class="modal-content" style="padding: 0; background: transparent; width: auto; max-width: 95vw; max-height: 95vh; display: flex; justify-content: center; align-items: center; border: none; box-shadow: none;">
             <button class="modal-close" onclick="window.closeImageModal()" style="position: fixed; top: 20px; right: 20px; z-index: 1001; background: rgba(0,0,0,0.5); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; color: white; border: 1px solid rgba(255,255,255,0.3);">√ó</button>
             <img id="imageViewer" src="" style="max-width: 100%; max-height: 90vh; border-radius: 8px; box-shadow: 0 0 50px rgba(0,0,0,0.9); object-fit: contain;">
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        
        // Hi·ªán loader khi load trang
window.addEventListener('load', () => {
  // Gi·∫£ l·∫≠p th·ªùi gian load data (Cloudinary / localStorage)
  setTimeout(() => {
    document.getElementById('page-loader').classList.add('hide');
  }, 1800); // ch·ªânh nhanh/ch·∫≠m tu·ª≥ √Ω
});
    

        let GLOBAL_CONFIG = {
            cloudinary: {
                cloudName: 'dios7cyto',     // V√≠ d·ª•: 'doxyz123'
                uploadPreset: 'QN221205'   // V√≠ d·ª•: 'preset_noel'
            },
            firebase: {
                apiKey: "BF4FeUHM6SvafkQHyQUaUdPTmUcbK1dAfbZLwGT3ic2i91ittOHzFNo5I5ThR",        // V√≠ d·ª•: 'AIzaSyDn...'
                authDomain: "qn-source-storage.firebaseapp.com",
                databaseURL: "https://qn-source-storage-default-rtdb.firebaseio.com/",   // V√≠ d·ª•: 'https://xxx.firebaseio.com'
                projectId: "qn-source-storage",     // V√≠ d·ª•: 'christmas-123'
                storageBucket: "",
                messagingSenderId: "",
                appId: ""
            }
        };

        // Bi·∫øn to√†n c·ª•c
        let db = null;
        let dbRef = null;
        let albumData = [];
        let isFirebaseReady = false;

       function loadConfig() {
            const localCloud = localStorage.getItem('cloudConfig');
            const localFb = localStorage.getItem('firebaseConfig');

            if (GLOBAL_CONFIG.cloudinary.cloudName === 'dios7cyto' || !GLOBAL_CONFIG.cloudinary.cloudName) {
                if (localCloud) {
                    const parsed = JSON.parse(localCloud);
                    GLOBAL_CONFIG.cloudinary.cloudName = parsed.cloudName;
                    GLOBAL_CONFIG.cloudinary.uploadPreset = parsed.uploadPreset;
                }
            }

            if (GLOBAL_CONFIG.firebase.apiKey === 'BF4FeUHM6SvafkQHyQUaUdPTmUcbK1dAfbZLwGT3ic2i91ittOHzFNo5I5ThR' || !GLOBAL_CONFIG.firebase.apiKey) {
                if (localFb) {
                    const parsed = JSON.parse(localFb);
                    GLOBAL_CONFIG.firebase.apiKey = parsed.apiKey;
                    GLOBAL_CONFIG.firebase.projectId = parsed.projectId;
                    GLOBAL_CONFIG.firebase.databaseURL = parsed.databaseURL;
                }
            }

            const cName = GLOBAL_CONFIG.cloudinary.cloudName === 'dios7cyto' ? '' : GLOBAL_CONFIG.cloudinary.cloudName;
            const cPreset = GLOBAL_CONFIG.cloudinary.uploadPreset === 'QN221205' ? '' : GLOBAL_CONFIG.cloudinary.uploadPreset;
            const fKey = GLOBAL_CONFIG.firebase.apiKey === 'BF4FeUHM6SvafkQHyQUaUdPTmUcbK1dAfbZLwGT3ic2i91ittOHzFNo5I5ThR' ? '' : GLOBAL_CONFIG.firebase.apiKey;
            const fProj = GLOBAL_CONFIG.firebase.projectId === 'qn-source-storage' ? '' : GLOBAL_CONFIG.firebase.projectId;
            const fUrl = GLOBAL_CONFIG.firebase.databaseURL === 'https://qn-source-storage-default-rtdb.firebaseio.com/' ? '' : GLOBAL_CONFIG.firebase.databaseURL;

            if(document.getElementById('cloudNameInput')) {
                document.getElementById('cloudNameInput').value = cName || '';
                document.getElementById('presetInput').value = cPreset || '';
                document.getElementById('fbApiKey').value = fKey || '';
                document.getElementById('fbProjectId').value = fProj || '';
                document.getElementById('fbDbUrl').value = fUrl || '';
            }
        }

        // Kh·ªüi t·∫°o Firebase
        function initFirebase() {
            const fbConfig = GLOBAL_CONFIG.firebase;
            if (fbConfig.apiKey && fbConfig.databaseURL) {
                try {
                    const app = initializeApp(fbConfig);
                    db = getDatabase(app);
                    dbRef = ref(db, 'christmasStory');
                    
                    onValue(dbRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            albumData = data;
                        } else {
                            albumData = [{ id: Date.now(), left: null, right: null, datetime: new Date().toISOString() }];
                            set(dbRef, albumData);
                        }
                        renderAlbum();
                        isFirebaseReady = true;
                        document.getElementById('setup-message').style.display = 'none';
                    });
                } catch (e) {
                    console.error(e);
                    showError("L·ªói k·∫øt n·ªëi Firebase: " + e.message);
                }
            } else {
                document.getElementById('setup-message').style.display = 'block';
                const localData = localStorage.getItem('christmasAlbum');
                if(localData) {
                    albumData = JSON.parse(localData);
                    renderAlbum();
                }
            }
        }

        window.saveSettings = function() {
            const cloudName = document.getElementById('cloudNameInput').value.trim();
            const preset = document.getElementById('presetInput').value.trim();
            const fbApiKey = document.getElementById('fbApiKey').value.trim();
            const fbProjectId = document.getElementById('fbProjectId').value.trim();
            const fbDbUrl = document.getElementById('fbDbUrl').value.trim();

            if (!cloudName || !preset || !fbApiKey || !fbDbUrl) {
                showError("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng quan tr·ªçng!");
                return;
            }

            localStorage.setItem('cloudConfig', JSON.stringify({ cloudName, uploadPreset: preset }));
            localStorage.setItem('firebaseConfig', JSON.stringify({ apiKey: fbApiKey, projectId: fbProjectId, databaseURL: fbDbUrl }));

            GLOBAL_CONFIG.cloudinary.cloudName = cloudName;
            GLOBAL_CONFIG.cloudinary.uploadPreset = preset;
            GLOBAL_CONFIG.firebase.apiKey = fbApiKey;
            GLOBAL_CONFIG.firebase.projectId = fbProjectId;
            GLOBAL_CONFIG.firebase.databaseURL = fbDbUrl;

            window.closeSettings();
            initFirebase();
            location.reload();
        };

        window.openSettings = function() {
            document.getElementById('settingsModal').classList.add('active');
        };

        window.closeSettings = function() {
            document.getElementById('settingsModal').classList.remove('active');
        };

        window.showError = function(msg) {
            const toast = document.getElementById('error-toast');
            toast.innerText = msg;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 4000);
        };

        window.showLoading = function(show, text = 'Em y√™u ch·ªù ch√∫t x√≠u nh√©...') {
            const overlay = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').innerText = text;
            overlay.style.display = show ? 'flex' : 'none';
        };

        window.resetStory = function() {
            if(confirm('C·∫¢NH B√ÅO: H√†nh ƒë·ªông n√†y s·∫Ω x√≥a to√†n b·ªô d·ªØ li·ªáu tr√™n Database c·ªßa t·∫•t c·∫£ m·ªçi ng∆∞·ªùi! B·∫°n ch·∫Øc ch·∫Øn ch·ª©?')) {
                if(isFirebaseReady) {
                    set(dbRef, [{ id: Date.now(), left: null, right: null, datetime: new Date().toISOString() }]);
                } else {
                    localStorage.removeItem('christmasAlbum');
                    location.reload();
                }
            }
        };

        // Image Processing
        function processImage(file) {
            return new Promise((resolve, reject) => {
                const maxWidth = 1920;
                const maxHeight = 1080;
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function(event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = function() {
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth || height > maxHeight) {
                            if (width > height) {
                                if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                            } else {
                                if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                            }
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', 0.85);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        async function uploadToCloud(file, type) {
            const { cloudName, uploadPreset } = GLOBAL_CONFIG.cloudinary;
            if (!cloudName || !uploadPreset) {
                throw new Error("Ch∆∞a c·∫•u h√¨nh Cloudinary!");
            }

            const url = `https://api.cloudinary.com/v1_1/${cloudName}/${type}/upload`;
            const formData = new FormData();
            
            if (type === 'image') {
                try {
                    const processedBlob = await processImage(file);
                    formData.append('file', processedBlob);
                } catch(e) {
                    formData.append('file', file);
                }
            } else {
                formData.append('file', file);
            }
            
            formData.append('upload_preset', uploadPreset);

            try {
                const response = await fetch(url, { method: 'POST', body: formData });
                const data = await response.json();
                if (!response.ok) {
                    let msg = data.error?.message || 'L·ªói upload';
                    if (msg.includes('Unknown API key')) msg = 'Sai "Cloud Name". Ki·ªÉm tra l·∫°i!';
                    if (msg.includes('upload_preset')) msg = 'Sai "Upload Preset" ho·∫∑c ch∆∞a ch·ªçn ch·∫ø ƒë·ªô Unsigned.';
                    throw new Error(msg);
                }
                return data.secure_url;
            } catch (error) {
                throw error;
            }
        }

        function saveData() {
            if (isFirebaseReady && dbRef) {
                set(dbRef, albumData);
            } else {
                localStorage.setItem('christmasAlbum', JSON.stringify(albumData));
                window.showError("Ch∆∞a k·∫øt n·ªëi Firebase! D·ªØ li·ªáu ch·ªâ l∆∞u t·∫°m tr√™n m√°y n√†y.");
            }
        }

        function sortByDateTime() {
            albumData.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
        }

        window.renderAlbum = function() {
            const grid = document.getElementById('albumGrid');
            grid.innerHTML = albumData.map((row, index) => {
                const date = new Date(row.datetime);
                const dateStr = date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <div class="photo-row" style="animation-delay: ${index * 0.1}s">
                        <div class="timeline-dot">üéÅ</div>
                        <div class="photo-side left ${row.left ? 'reveal' : ''}">
                            <div class="time-control">
                                <div class="time-icon">üìÖ</div>
                                <div class="time-input-wrapper">
                                    <span class="time-display">${dateStr} ‚Ä¢ ${timeStr}</span>
                                    <input type="datetime-local" class="time-input" id="time-${index}" value="${formatDateTimeLocal(row.datetime)}">
                                </div>
                                <button class="save-time-btn" onclick="window.updateDateTime(${index})">üíæ L∆∞u</button>
                            </div>
                            ${renderCell(row.left, index, 'left')}
                        </div>
                        <div class="photo-side right ${row.right ? 'reveal' : ''}">
                            <div class="time-control">
                                <div class="time-icon">üïê</div>
                                <div class="time-input-wrapper">
                                    <span class="time-display">${dateStr} ‚Ä¢ ${timeStr}</span>
                                </div>
                            </div>
                            ${renderCell(row.right, index, 'right')}
                        </div>
                    </div>
                `;
            }).join('');
            
            updateStringPath();
            observeScroll();
        }

        function formatDateTimeLocal(datetime) {
            const date = new Date(datetime);
            const offset = date.getTimezoneOffset();
            const localDate = new Date(date.getTime() - (offset * 60 * 1000));
            return localDate.toISOString().slice(0, 16);
        }

        function renderCell(content, rowIndex, side) {
            if (!content) {
                return `
                    <div class="empty-placeholder">
                        <div style="font-size: 3em; opacity: 0.5;">üì∏</div>
                        <div class="upload-options">
                            <button class="upload-btn" onclick="window.uploadSingle(${rowIndex}, '${side}', 'image')">üì∑ ·∫¢nh ƒë∆°n</button>
                            <button class="upload-btn" onclick="window.uploadSingle(${rowIndex}, '${side}', 'video')">üé¨ Video</button>
                            <button class="upload-btn" onclick="window.uploadAlbum(${rowIndex}, '${side}')">üñºÔ∏è Album</button>
                        </div>
                    </div>
                `;
            }

            if (content.type === 'single') {
                const isVideo = content.mediaType === 'video';
                return `
                    <div class="photo-grid">
                        <button class="delete-btn" onclick="window.deleteContent(${rowIndex}, '${side}')">√ó</button>
                        ${isVideo ? 
                            `<div style="position: relative;">
                                <video class="single-media" onclick="window.playVideo('${content.url}')"><source src="${content.url}"></video>
                                <div class="video-play-icon">‚ñ∂</div>
                            </div>` :
                            `<img src="${content.url}" class="single-media" onclick="window.viewImage('${content.url}')" style="cursor: pointer;">`
                        }
                        <textarea class="caption-input" placeholder="Vi·∫øt g√¨ ƒë√≥..." onchange="window.updateCaption(${rowIndex}, '${side}', this.value)">${content.caption || ''}</textarea>
                    </div>
                `;
            }

            if (content.type === 'album') {
                const count = content.items.length;
                return `
                    <div class="photo-grid">
                        <button class="delete-btn" onclick="window.deleteContent(${rowIndex}, '${side}')">√ó</button>
                        <div class="album-grid count-${Math.min(count, 5)}" onclick="window.viewAlbum(${rowIndex}, '${side}')">
                            ${content.items.slice(0, 5).map(item => `
                                <div class="album-item">
                                    ${item.mediaType === 'video' ? `<video><source src="${item.url}"></video><div class="video-play-icon">‚ñ∂</div>` : `<img src="${item.url}">`}
                                </div>`).join('')}
                            ${count > 5 ? `<div class="album-badge">+${count - 5} ·∫£nh</div>` : ''}
                        </div>
                        <textarea class="caption-input" placeholder="Vi·∫øt g√¨ ƒë√≥..." onchange="window.updateCaption(${rowIndex}, '${side}', this.value)">${content.caption || ''}</textarea>
                    </div>
                `;
            }
        }

        // --- Interaction Functions ---

        window.uploadSingle = function(index, side, mediaType) {
            if (!GLOBAL_CONFIG.cloudinary.cloudName) { window.openSettings(); window.showError("C·∫ßn c·∫•u h√¨nh Cloudinary tr∆∞·ªõc!"); return; }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = mediaType === 'video' ? 'video/*' : 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                window.showLoading(true, 'Em iu ch·ªù √¥ng gi√† Santa x√≠u ha...');
                try {
                    const url = await uploadToCloud(file, mediaType);
                    albumData[index][side] = { type: 'single', mediaType, url, caption: '' };
                    checkAndAddNewRow(index);
                    saveData();
                } catch (err) { window.showError(err.message); } 
                finally { window.showLoading(false); }
            };
            input.click();
        }

        window.uploadAlbum = function(index, side) {
            if (!GLOBAL_CONFIG.cloudinary.cloudName) { window.openSettings(); window.showError("C·∫ßn c·∫•u h√¨nh Cloudinary tr∆∞·ªõc!"); return; }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*';
            input.multiple = true;
            input.onchange = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                window.showLoading(true, `Em iu ch·ªù x√≠u ha, 0/${files.length}...`);
                const items = [];
                for (let i = 0; i < files.length; i++) {
                    const isVideo = files[i].type.startsWith('video/');
                    try {
                        window.showLoading(true, `Em iu ch·ªù x√≠u ha ${i + 1}/${files.length}...`);
                        const url = await uploadToCloud(files[i], isVideo ? 'video' : 'image');
                        items.push({ mediaType: isVideo ? 'video' : 'image', url });
                    } catch (err) { console.error(err); }
                }
                window.showLoading(false);
                if (items.length > 0) {
                    albumData[index][side] = { type: 'album', items, caption: '' };
                    checkAndAddNewRow(index);
                    saveData();
                }
            };
            input.click();
        }

        function checkAndAddNewRow(index) {
            if (index === albumData.length - 1 && albumData[index].left && albumData[index].right) {
                albumData.push({ id: Date.now(), left: null, right: null, datetime: new Date().toISOString() });
            }
        }

        window.updateDateTime = function(index) {
            const input = document.getElementById(`time-${index}`);
            albumData[index].datetime = new Date(input.value).toISOString();
            sortByDateTime();
            saveData();
        }

        window.updateCaption = function(index, side, value) {
            if(albumData[index] && albumData[index][side]) {
                albumData[index][side].caption = value;
                saveData();
            }
        }

        window.deleteContent = function(index, side) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?')) {
                albumData[index][side] = null;
                saveData();
                if(!isFirebaseReady) renderAlbum();
            }
        }

        // --- View Image / Lightbox Logic ---
        window.viewImage = function(url) {
            const viewer = document.getElementById('imageViewer');
            viewer.src = url;
            document.getElementById('imageModal').classList.add('active');
        }

        window.closeImageModal = function() {
            document.getElementById('imageModal').classList.remove('active');
            setTimeout(() => { document.getElementById('imageViewer').src = ''; }, 300);
        }

        window.viewAlbum = function(index, side) {
            const content = albumData[index][side];
            const viewer = document.getElementById('albumViewer');
            viewer.innerHTML = `
                <h2>üñºÔ∏è Album (${content.items.length} items)</h2>
                <div class="album-viewer-grid">
                    ${content.items.map(item => `
                        <div class="album-viewer-item">
                            ${item.mediaType === 'video' 
                                ? `<div onclick="window.playVideo('${item.url}')" style="cursor:pointer; position: relative; height:100%;"><video style="width:100%; height:100%; object-fit:cover;"><source src="${item.url}"></video><div class="video-play-icon" style="font-size:2em;">‚ñ∂</div></div>` 
                                : `<img src="${item.url}" onclick="window.viewImage('${item.url}')" style="cursor:pointer;">`
                            }
                        </div>`).join('')}
                </div>`;
            document.getElementById('albumModal').classList.add('active');
        }

        window.closeModal = function() { document.getElementById('albumModal').classList.remove('active'); }
        window.playVideo = function(url) {
            const player = document.getElementById('videoPlayer');
            player.src = url;
            document.getElementById('videoModal').classList.add('active');
            player.play();
        }
        window.closeVideoModal = function() {
            const player = document.getElementById('videoPlayer');
            player.pause();
            document.getElementById('videoModal').classList.remove('active');
        }

        // --- Effects ---
        function updateStringPath() {
            const rows = document.querySelectorAll('.photo-row');
            if (rows.length === 0) return;
            const svg = document.querySelector('.timeline-center-line svg');
            const svgRect = svg.getBoundingClientRect();
            const centerX = svgRect.width / 2;
            let path = `M ${centerX} 0 `;
            let lightPositions = [];
            rows.forEach((row, i) => {
                const rect = row.getBoundingClientRect();
                const rowY = rect.top + rect.height / 2 - svgRect.top;
                const wave = Math.sin(i * 0.8) * 30;
                path += `Q ${centerX + wave} ${rowY - 40}, ${centerX} ${rowY} `;
                lightPositions.push({ x: centerX, y: rowY });
            });
            path += `L ${centerX} ${svgRect.height}`;
            document.getElementById('stringPath').setAttribute('d', path);
            document.getElementById('lightsGroup').innerHTML = lightPositions.map((pos, i) => {
                const color = ['#f4a261', '#e63946', '#2a9d8f', '#e9c46a'][i % 4];
                return `<circle class="light-bulb" cx="${pos.x}" cy="${pos.y}" r="8" fill="${color}"><animate attributeName="r" values="6;10;6" dur="2s" begin="${i * 0.3}s" repeatCount="indefinite"/></circle>`;
            }).join('');
        }

        function observeScroll() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('reveal'); });
            }, { threshold: 0.1 });
            document.querySelectorAll('.photo-side').forEach(el => observer.observe(el));
        }

        // Snow Effect
        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        function initSnow() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            particles = Array(150).fill().map(() => ({
                x: Math.random() * canvas.width, y: Math.random() * canvas.height,
                r: Math.random() * 4 + 1, d: Math.random(), opacity: Math.random() * 0.5 + 0.5
            }));
        }
        function drawSnow() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                ctx.beginPath(); ctx.fillStyle = `rgba(255, 255, 255, ${p.opacity})`;
                ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2); ctx.fill();
                p.y += Math.cos(p.d) + 1 + p.r / 2; p.x += Math.sin(p.d) * 2;
                if(p.y > canvas.height) { p.y = -10; p.x = Math.random() * canvas.width; }
            });
            requestAnimationFrame(drawSnow);
        }
        
        // Init
        loadConfig();
        initFirebase();
        initSnow();
        drawSnow();
        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; updateStringPath(); });
        window.addEventListener('scroll', updateStringPath);

    </script>


<script>
        function goTree(){
  window.location.href = 'tree.html';
}

window.addEventListener('load', () => {
    if (sessionStorage.getItem('userInteracted') === 'true') {
        const audio = document.getElementById('bgMusic');
        audio.volume = 0.6;
        audio.play().catch(() => {});
    }
});


</script>
</body>
</html>